<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>p5 + A-Frame VR Debug Example</title>

  <!-- A-Frame for VR/AR -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <!-- p5.js and p5.sound -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.5.0/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.5.0/addons/p5.sound.min.js"></script>

  <style>
    body { 
      margin: 0; 
      padding: 0; 
      overflow: hidden; /* remove scrollbars */
    }
    #startButton {
      position: absolute;
      z-index: 999;
      top: 20px;
      left: 20px;
      padding: 10px 15px;
      font-size: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Button to explicitly start the audio & p5 draw() loop -->
  <button id="startButton" onclick="startAudio()">
    Start Audio
  </button>

  <!-- A-Frame Scene -->
  <a-scene>
    <!-- Camera at eye-height: y=1.6, with look-controls for VR head tracking -->
    <a-entity camera look-controls position="0 1.6 0"></a-entity>

    <!-- Plane is only 1 meter away (z=-1). 
         That way it's close and easy to see. -->
    <a-plane
      id="p5-plane"
      position="0 1.6 -1"
      rotation="0 0 0"
      width="1.5"   <!-- Slightly smaller plane -->
      height="1.5"
      material="side: double;" 
    ></a-plane>
  </a-scene>

  <script>
    // ------------------------------------------
    // p5.js SKETCH SETUP
    // ------------------------------------------
    let sound, fft;
    let myCanvas;

    // For debugging, let's do a super simple shape in draw().
    // Once you confirm it's visible, you can reintroduce your
    // original complexity (numLayers, etc.).

    function preload() {
      // Ensure your MP3 file has no spaces in the name.
      // Place it in the same folder as this HTML.
      sound = loadSound('StanfordOutpatient3_piano.mp3');
    }

    function setup() {
      // Use a 512x512 canvas for a crisp VR texture
      myCanvas = createCanvas(512, 512);
      frameRate(20);

      fft = new p5.FFT();

      // Link this p5 canvas to the <a-plane> in A-Frame
      const plane = document.querySelector('#p5-plane');
      plane.setAttribute('material', 'src', myCanvas.elt);

      // Don't start the draw loop yet:
      noLoop();
      console.log("p5 setup complete. Waiting to start audio...");
    }

    // ------------------------------------------
    // p5.js DRAW
    // ------------------------------------------
    function draw() {
      // For debugging, let's do a bright background:
      background(255, 0, 0); // bright red
      console.log("draw() is running, frameCount:", frameCount);

      // Example audio reaction: a circle that changes size
      let amplitude = fft.getEnergy("mid");
      let circleSize = map(amplitude, 0, 255, 50, 200);

      fill(255); 
      noStroke();
      ellipse(width/2, height/2, circleSize, circleSize);

      // If you want to test animation, let's rotate a rectangle:
      push();
      translate(width/2, height/2);
      rotate(frameCount * 2); 
      fill(0, 255, 0);
      rectMode(CENTER);
      rect(0, 0, 100, 50);
      pop();
    }

    // ------------------------------------------
    // START AUDIO (USER GESTURE)
    // ------------------------------------------
    function startAudio() {
      if (!sound.isPlaying()) {
        sound.play();
        loop(); // now draw() will run repeatedly
        console.log("Audio started, draw loop is now active.");
      }
    }
  </script>
</body>
</html>
