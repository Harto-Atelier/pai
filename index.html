<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>p5 + A-Frame VR (Click in VR)</title>

  <!-- A-Frame for VR -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <!-- p5.js and p5.sound for audio & drawing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.5.0/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.5.0/addons/p5.sound.min.js"></script>

  <style>
    body {
      margin: 0; 
      padding: 0; 
      overflow: hidden; /* Hide scrollbars */
    }
  </style>
</head>
<body>

  <!-- A-Frame Scene -->
  <a-scene>

    <!-- Camera entity with look-controls, plus a GAZE cursor in front of the camera.
         In VR, you point your head (or look at something) and press trigger. -->
    <a-entity camera look-controls>
      <a-entity 
        cursor="fuse: false; fuseTimeout: 1500" 
        position="0 0 -1" 
        geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
        material="color: cyan; shader: flat;"
      >
      </a-entity>
    </a-entity>

    <!-- Plane to display our p5 canvas as a texture.
         class="clickable" means the cursor can emit a "click" event on it. -->
    <a-plane
      id="p5-plane"
      class="clickable"
      position="0 1.6 -1"   <!-- 1 meter in front of you, at head height -->
      width="1.5"
      height="1.5"
      material="side: double;" 
    ></a-plane>

  </a-scene>

  <script>
    // ----------------------------------------
    // p5.js Variables
    // ----------------------------------------
    let sound, fft;
    let myCanvas;

    // ----------------------------------------
    // p5.js Preload
    // ----------------------------------------
    function preload() {
      // Load your MP3 WITHOUT spaces
      // Must be in the same folder as this HTML file
      sound = loadSound('StanfordOutpatient3_piano.mp3');
    }

    // ----------------------------------------
    // p5.js Setup
    // ----------------------------------------
    function setup() {
      // Create a 512x512 canvas for crisp VR texture
      myCanvas = createCanvas(512, 512);
      frameRate(20);

      fft = new p5.FFT();

      // We'll not automatically loop the draw().
      // We'll start it after a click in VR.
      noLoop();

      // Link the p5 canvas as a texture on the a-plane
      let plane = document.querySelector('#p5-plane');
      plane.setAttribute('material', 'src', myCanvas.elt);

      // ------------------------------------------------
      // IMPORTANT: Listen for clicks on the PLANE
      // (i.e. when the user gazes at the plane and presses the controller trigger)
      // ------------------------------------------------
      plane.addEventListener('click', function () {
        console.log('Plane was clicked in VR!');

        // Start audio + draw loop if not already playing
        if (!sound.isPlaying()) {
          sound.play();
          loop(); // start p5's draw() loop
        }
      });

      console.log('Setup complete. Waiting for plane click to start audio & draw...');
    }

    // ----------------------------------------
    // p5.js Draw
    // ----------------------------------------
    function draw() {
      // For debug: bright red background
      background(255, 0, 0);
      console.log('draw() running, frameCount=', frameCount);

      // Analyze audio for a simple amplitude-based shape
      let amplitude = fft.getEnergy("mid");
      let circleSize = map(amplitude, 0, 255, 50, 200);

      // White circle in the middle
      fill(255);
      noStroke();
      ellipse(width/2, height/2, circleSize, circleSize);

      // Rotating green rectangle for motion
      push();
      translate(width/2, height/2);
      rotate(frameCount * 2); 
      fill(0, 255, 0);
      rectMode(CENTER);
      rect(0, 0, 100, 50);
      pop();
    }
  </script>

</body>
</html>
